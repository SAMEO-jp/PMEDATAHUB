# データベース追加作業標準書

**文書バージョン**: 1.0
**作成日**: 2025-10-17
**対象システム**: PLM アプリケーション
**目的**: データベース設計・実装の標準化

## 概要

この標準書は、PLMアプリケーションにおけるデータベース設計・実装の一貫した品質を保つための詳細な手順を定義します。

## 1. データベース設計原則

### 1.0 既存データベース活用優先方針

**基本原則**:
- **既存DB最優先活用** - 新規DB作成は明示的な依頼がない限り実施しない
- **既存テーブル構造の最大限活用** - 新機能は既存テーブルでの対応可能性を最優先で検証
- **最小限の変更原則** - カラム追加で対応可能な場合は新規テーブル作成しない

**判断基準**:
1. 既存テーブルでの対応可能性を最優先で検証
2. カラム追加で対応可能な場合は新規テーブル作成しない
3. 新規テーブルは既存構造で絶対に対応不可能な場合のみ
4. 明示的な新規DB作成依頼がない限り、別DBは作成しない

**作業手順**:
1. 既存スキーマの完全理解
2. 新機能の既存テーブルでの実現可能性検証
3. 最小限の変更案の策定
4. 影響分析とリスク評価
5. 段階的実装

### 1.1 命名規則

#### テーブル命名
- **日本語マッピング必須**: `@@map("日本語名")`
- **英語名は複数形**: `Users`, `Products`, `Histories`
- **履歴テーブル**: `XxxHistory` (例: `PositionHistory`)

#### カラム命名
- **日本語マッピング必須**: `@map("日本語名")`
- **外部キー**: `xxx_id` 形式
- **フラグ**: `is_xxx` 形式
- **日時**: `xxx_at` 形式 (added_at, deleted_at, updated_at)

### 1.2 型定義原則

#### 基本型
```prisma
id          Int      @id @default(autoincrement()) @map("id")
created_at  DateTime @default(now()) @map("追加日")
updated_at  DateTime @updatedAt @map("更新日")
deleted_at  DateTime? @map("削除日")
is_visible  Boolean  @default(true) @map("表示非表示")
```

#### 履歴管理
```prisma
model XxxHistory {
  id              Int      @id @default(autoincrement()) @map("id")
  target_id       Int      @map("対象ID")
  added_at        DateTime @map("追加日")
  deleted_at      DateTime? @map("削除日")

  @@map("xxx履歴")
}
```

## 2. スキーマ設計手順

### Step 1: 要件分析
1. **エンティティ特定**
   - 管理対象データの洗い出し
   - エンティティ間の関係性の把握
   - 履歴管理の必要性確認

2. **データフロー分析**
   - 入力データの流れ
   - 更新・削除の頻度
   - 参照パターンの特定

### Step 2: モデル設計

#### 2.1 基本モデル設計
```prisma
model EntityName {
  // 主キー
  id          Int      @id @default(autoincrement()) @map("id")

  // 業務データ
  name        String   @map("名称")
  description String?  @map("説明")

  // システムデータ
  created_at  DateTime @default(now()) @map("追加日")
  updated_at  DateTime @updatedAt @map("更新日")
  deleted_at  DateTime? @map("削除日")
  is_visible  Boolean  @default(true) @map("表示非表示")

  // リレーション

  @@map("エンティティ名")
}
```

#### 2.2 履歴モデル設計
```prisma
model EntityHistory {
  id          Int      @id @default(autoincrement()) @map("id")
  entity_id   Int      @map("エンティティID")

  // 履歴データ（元テーブルの業務データをコピー）
  name        String   @map("名称")
  description String?  @map("説明")

  // 履歴管理
  added_at    DateTime @map("追加日")
  deleted_at  DateTime? @map("削除日")
  add_reason  String?  @map("追加理由")

  // リレーション
  entity      EntityName @relation(fields: [entity_id], references: [id])

  @@map("エンティティ履歴")
}
```

### Step 3: リレーション設計

#### 一対多関係
```prisma
model Parent {
  id       Int      @id @default(autoincrement()) @map("id")
  children Child[]

  @@map("親テーブル")
}

model Child {
  id        Int    @id @default(autoincrement()) @map("id")
  parent_id Int    @map("親ID")
  parent    Parent @relation(fields: [parent_id], references: [id])

  @@map("子テーブル")
}
```

#### 自己参照関係
```prisma
model Department {
  id        Int           @id @default(autoincrement()) @map("id")
  parent_id Int?          @map("親部署ID")
  parent    Department?   @relation("DepartmentHierarchy", fields: [parent_id], references: [id])
  children  Department[]  @relation("DepartmentHierarchy")

  @@map("部署")
}
```

## 3. 実装手順

### 3.1 事前準備
1. **現在のスキーマバックアップ**
```bash
cp src/apps/plm/prismas/prisma.prisma src/apps/plm/prismas/prisma.prisma.backup
```

2. **依存関係確認**
- 既存テーブルとの関係性チェック
- 外部キー制約の確認

### 3.2 スキーマ更新

#### 新規テーブル追加例
```prisma
// 1. モデル定義
model NewEntity {
  id          Int      @id @default(autoincrement()) @map("id")
  name        String   @map("名称")
  created_at  DateTime @default(now()) @map("追加日")
  updated_at  DateTime @updatedAt @map("更新日")

  @@map("新エンティティ")
}

// 2. 履歴テーブル追加
model NewEntityHistory {
  id           Int       @id @default(autoincrement()) @map("id")
  entity_id    Int       @map("エンティティID")
  name         String    @map("名称")
  added_at     DateTime  @map("追加日")
  deleted_at   DateTime? @map("削除日")

  entity       NewEntity @relation(fields: [entity_id], references: [id])

  @@map("新エンティティ履歴")
}
```

### 3.3 マイグレーション実行
```bash
# 1. マイグレーション生成
npx prisma migrate dev --name add_new_entity

# 2. クライアント生成
npx prisma generate

# 3. データベース状態確認
npx prisma studio
```

## 4. 品質チェック項目

### 4.1 設計品質
- [ ] 正規化レベルの適切性
- [ ] インデックス設計の妥当性
- [ ] 外部キー制約の適切な設定
- [ ] 削除時のカスケード設定

### 4.2 命名品質
- [ ] 日本語マッピングの一貫性
- [ ] 英語命名の統一性
- [ ] リレーション名の明確性

### 4.3 パフォーマンス
- [ ] クエリパフォーマンスの検証
- [ ] インデックス効果の確認
- [ ] N+1クエリ問題の回避

## 5. テストデータ作成

### 5.1 シードデータ設計
```typescript
// prisma/seed.ts
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function main() {
  // 部署データ
  const departments = await prisma.departmentInfo.createMany({
    data: [
      { name: '開発部', full_name: '技術開発部', added_at: new Date() },
      { name: '営業部', full_name: '営業企画部', added_at: new Date() },
    ]
  })

  // 社員データ
  const employees = await prisma.employeeInfo.createMany({
    data: [
      { employee_number: 1001, department_id: 1 },
      { employee_number: 1002, department_id: 2 },
    ]
  })
}

main()
  .catch((e) => console.error(e))
  .finally(async () => await prisma.$disconnect())
```

### 5.2 テストデータ実行
```bash
# シードデータ実行
npx prisma db seed

# データ確認
npx prisma studio
```

## 6. データベース追加テストの定義

### 6.1 DBテストの正しい理解
- **DBテストの目的**: 追加したテーブルがデータベースに正しく作成されているかを確認
- **対象**: データベーススキーマとテーブル構造の確認
- **非対象**: アプリケーションサーバーの起動確認（npm run dev）

### 6.2 適切なDBテスト手順
```bash
# 1. マイグレーション実行
npx prisma migrate dev --name add_table_name

# 2. データベース接続確認
npx prisma db pull

# 3. テーブル存在確認（SQLiteの場合）
sqlite3 データベースファイル.db ".tables"

# 4. テーブル構造確認
sqlite3 データベースファイル.db ".schema テーブル名"

# 5. Prismaクライアント生成確認
npx prisma generate

# 6. 視覚的確認（オプション）
npx prisma studio
```

### 6.3 誤ったテスト方法
- ❌ **npm run dev実行**: アプリケーションサーバー起動はDBテストではない
- ❌ **ページアクセス**: フロントエンド動作確認はDBテストとは別工程
- ❌ **ビルドテスト**: アプリケーションビルドはDBテストとは無関係

### 6.4 DBテスト完了の判定基準
- [ ] マイグレーションがエラーなく完了
- [ ] 追加したテーブルがデータベースに存在
- [ ] テーブル構造が設計通りに作成
- [ ] Prismaクライアントが正常生成
- [ ] 既存テーブルとの整合性が保たれている

## 6. ドキュメント更新

### 6.1 必須ドキュメント
1. **ER図の更新**: `docs/database/er-diagram.md`
2. **テーブル定義書**: `docs/database/table-definitions.md`
3. **マイグレーション履歴**: `docs/database/migration-history.md`

### 6.2 更新内容
- 追加したテーブルの説明
- リレーションの変更点
- パフォーマンス考慮事項
- 今後の改善点

---

この標準書に従うことで、一貫した品質のデータベース設計・実装が可能になります。