@echo off
chcp 65001 > nul
title PME DataHub - è‡ªå‹•èµ·å‹•

echo.
echo ========================================
echo    ðŸš€ PME DataHub è‡ªå‹•èµ·å‹•ã‚·ã‚¹ãƒ†ãƒ 
echo ========================================
echo.

:: ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
set "CURRENT_DIR=%~dp0"
cd /d "%CURRENT_DIR%"

:: Node.jsãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
node --version >nul 2>&1
if errorlevel 1 (
    echo âŒ ã‚¨ãƒ©ãƒ¼: Node.jsãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“
    echo    Node.jsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„: https://nodejs.org/
    pause
    exit /b 1
)

echo âœ… Node.js ãŒç¢ºèªã§ãã¾ã—ãŸ
node --version

:: å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if not exist "server.js" (
    echo âŒ ã‚¨ãƒ©ãƒ¼: server.js ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
    pause
    exit /b 1
)

if not exist "package.json" (
    echo âŒ ã‚¨ãƒ©ãƒ¼: package.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
    pause
    exit /b 1
)

echo âœ… å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒç¢ºèªã§ãã¾ã—ãŸ

:: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆåˆå›žã®ã¿ï¼‰
if not exist "node_modules" (
    echo ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™...
    npm install
    if errorlevel 1 (
        echo âŒ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ
        pause
        exit /b 1
    )
    echo âœ… ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸ
)

:: ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
echo.
echo ðŸš€ ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...
echo    ãƒãƒ¼ãƒˆ: 3000
echo    URL: http://localhost:3000
echo.

:: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
start /b "" node server.js

:: ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’å¾…æ©Ÿ
echo â³ ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™...
timeout /t 3 /nobreak > nul

:: ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
:check_server
curl -s http://localhost:3000 >nul 2>&1
if errorlevel 1 (
    echo ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­...
    timeout /t 2 /nobreak > nul
    goto check_server
)

echo âœ… ã‚µãƒ¼ãƒãƒ¼ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸï¼

:: ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ã
echo ðŸŒ ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ã„ã¦ã„ã¾ã™...
start http://localhost:3000

echo.
echo ========================================
echo    âœ… PME DataHub ãŒèµ·å‹•ã—ã¾ã—ãŸï¼
echo ========================================
echo.
echo ðŸ“‹ æ“ä½œæ–¹æ³•:
echo    - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³: http://localhost:3000
echo    - ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹ã¨ã‚µãƒ¼ãƒãƒ¼ãŒåœæ­¢ã—ã¾ã™
echo    - æ‰‹å‹•ã§åœæ­¢ã™ã‚‹å ´åˆã¯ Ctrl+C ã‚’æŠ¼ã—ã¦ãã ã•ã„
echo.

:: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½•ã‹ã‚­ãƒ¼ã‚’æŠ¼ã™ã¾ã§å¾…æ©Ÿ
echo ä½•ã‹ã‚­ãƒ¼ã‚’æŠ¼ã™ã¨ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¾ã™...
pause >nul

echo.
echo ðŸ›‘ ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¦ã„ã¾ã™...

:: ãƒãƒ¼ãƒˆ3000ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢
for /f "tokens=5" %%a in ('netstat -aon ^| find ":3000" ^| find "LISTENING"') do (
    taskkill /f /pid %%a >nul 2>&1
)

echo âœ… ã‚µãƒ¼ãƒãƒ¼ãŒåœæ­¢ã—ã¾ã—ãŸ
echo.
echo ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã™...
timeout /t 2 /nobreak > nul
exit /b 0
