# Week Shiwake データ型整理仕様書

## 📋 概要

このドキュメントは、`week-shiwake/[year]/[week]`フォルダで使用されているデータ型の整理と統一を定義します。現在の型定義の重複、不整合、`any`型の多用を解決し、型安全性を向上させます。

## 🎯 現状の問題点

### 1. 型定義の重複と不整合

#### イベント関連の型
- **`EventItem`** (types/event.ts) - サーバーサイド用
- **`ClientEvent`** (types/event.ts) - クライアント表示用
- **`WeekEvent`** (page.tsx内) - ローカル定義（重複）
- **`ServerEvent`** (コメントアウト) - 未使用
- **`BaseEvent`** (__ignore__フォルダ) - 別プロジェクトの型

#### 型の不整合
```typescript
// 問題1: WeekEventとClientEventの混在
interface WeekEvent {
  [key: string]: unknown; // 型安全性の欠如
  // ... 他のプロパティ
}

interface ClientEvent {
  // 厳密な型定義
  // [key: string]: unknown がない
}
```

### 2. `any`型の多用

#### 現在の`any`型使用箇所
```typescript
// hooks/useWeekData.ts
const [employees, setEmployees] = useState<any[]>([])
const [projects, setProjects] = useState<any[]>([])

// hooks/useResizeEvent.ts
events: any[]
setEvents: React.Dispatch<React.SetStateAction<any[]>>

// lib/client-db.ts
export async function saveWeekAchievements(year: number, week: number, events: any[])

// components/TimeGrid.tsx
events: any[]

// lib/weekDataManager.ts
events: any[]
workTimes: any[]
```

### 3. 型変換の複雑性

#### 現在の型変換フロー
```typescript
// サーバー → クライアント
EventItem → ClientEvent (formatEventForClient)

// クライアント → サーバー
ClientEvent → EventItem (formatEventForServer)

// ローカルストレージ
ClientEvent[] ↔ localStorage
```

## 🔧 統一された型定義

### 1. 基本型定義

#### 1.1 共通ベース型
```typescript
// types/base.ts
export interface BaseEntity {
  id: string;
  keyID: string;
  employeeNumber: string;
  createdAt?: string;
  updatedAt?: string;
}

export interface BaseEvent extends BaseEntity {
  startDateTime: string;
  endDateTime: string;
  subject: string;
  content?: string;
  projectNumber?: string;
  type?: string;
  position?: string;
  facility?: string;
  status?: string;
  organizer?: string;
  businessCode?: string;
  departmentCode?: string;
  weekCode?: string;
  classification1?: string;
  classification2?: string;
  classification3?: string;
  classification4?: string;
  classification5?: string;
  classification6?: string;
  classification7?: string;
  classification8?: string;
  classification9?: string;
}
```

#### 1.2 サーバーサイド型
```typescript
// types/server.ts
export interface ServerEvent extends BaseEvent {
  // サーバー固有のプロパティ
  oldId?: string; // 更新時の元ID
}

export interface ServerAchievement extends ServerEvent {
  // 実績データ固有のプロパティ
}

export interface ServerWorkTime {
  date: string;
  startTime?: string;
  endTime?: string;
  employeeNumber: string;
  year: number;
  week: number;
}
```

#### 1.3 クライアントサイド型
```typescript
// types/client.ts
export interface ClientEvent extends BaseEvent {
  // クライアント表示用の追加プロパティ
  title: string;
  description: string;
  project: string;
  category: string;
  color: string;
  top: number;
  height: number;
  unsaved?: boolean;
  activityCode?: string;
  activityRow?: string;
  activityColumn?: string;
  activitySubcode?: string;
  equipmentNumber?: string;
}

export interface ClientWorkTime {
  date: string;
  startTime?: string;
  endTime?: string;
  isDefault?: boolean;
}

export interface ClientUser {
  employeeNumber: string;
  name: string;
  department?: string;
  position?: string;
}

export interface ClientProject {
  id: string;
  name: string;
  number: string;
  category?: string;
  color?: string;
}

export interface ClientEmployee {
  employeeNumber: string;
  name: string;
  department?: string;
  position?: string;
  isActive?: boolean;
}
```

### 2. 状態管理型

#### 2.1 UI状態型
```typescript
// types/ui.ts
export interface UIState {
  // タブ関連
  selectedTab: 'project' | 'indirect' | 'purchase';
  selectedProjectSubTab: string;
  indirectSubTab: string;
  
  // イベント選択
  selectedEvent: ClientEvent | null;
  activeEvent: ClientEvent | null;
  
  // 保存状態
  isSaving: boolean;
  hasChanges: boolean;
  isCtrlPressed: boolean;
  
  // メッセージ
  saveMessage: SaveMessage | null;
  apiError: string | null;
}

export interface SaveMessage {
  type: 'success' | 'error' | 'warning' | 'info';
  text: string;
  duration?: number;
}
```

#### 2.2 データ状態型
```typescript
// types/data.ts
export interface WeekDataState {
  // 基本データ
  events: ClientEvent[];
  workTimes: ClientWorkTime[];
  
  // マスターデータ
  employees: ClientEmployee[];
  projects: ClientProject[];
  currentUser: ClientUser;
  
  // メタデータ
  year: number;
  week: number;
  loading: boolean;
  apiError: string | null;
}

export interface WeekData {
  year: number;
  week: number;
  events: ClientEvent[];
  workTimes: ClientWorkTime[];
}
```

### 3. API型

#### 3.1 APIリクエスト型
```typescript
// types/api.ts
export interface APIResponse<T> {
  success: boolean;
  data: T;
  message?: string;
  error?: string;
}

export interface SaveWeekDataRequest {
  year: number;
  week: number;
  events: ServerEvent[];
}

export interface DeleteEventRequest {
  keyID: string;
}

export interface GetWeekDataResponse {
  events: ServerEvent[];
  workTimes: ServerWorkTime[];
}
```

## 🔄 型変換ユーティリティ

### 1. イベント変換
```typescript
// utils/typeConverters.ts
export function convertToClientEvent(serverEvent: ServerEvent): ClientEvent {
  const startTime = new Date(serverEvent.startDateTime);
  const endTime = new Date(serverEvent.endDateTime);
  
  const top = startTime.getHours() * 64 + (startTime.getMinutes() / 60) * 64;
  const duration = (endTime.getTime() - startTime.getTime()) / 60000;
  const height = (duration / 60) * 64;
  
  return {
    ...serverEvent,
    title: serverEvent.subject,
    description: serverEvent.content || '',
    project: serverEvent.projectNumber || '',
    category: serverEvent.type || '',
    color: getEventColor(serverEvent.type),
    top,
    height,
    unsaved: false,
  };
}

export function convertToServerEvent(clientEvent: ClientEvent): ServerEvent {
  return {
    ...clientEvent,
    subject: clientEvent.title,
    content: clientEvent.description,
    projectNumber: clientEvent.project,
    type: clientEvent.category,
  };
}
```

### 2. 勤務時間変換
```typescript
// utils/workTimeConverters.ts
export function convertToClientWorkTime(serverWorkTime: ServerWorkTime): ClientWorkTime {
  return {
    date: serverWorkTime.date,
    startTime: serverWorkTime.startTime,
    endTime: serverWorkTime.endTime,
  };
}

export function convertToServerWorkTime(clientWorkTime: ClientWorkTime, employeeNumber: string, year: number, week: number): ServerWorkTime {
  return {
    ...clientWorkTime,
    employeeNumber,
    year,
    week,
  };
}
```

## 📊 型安全性の向上

### 1. `any`型の置き換え

#### Before
```typescript
// hooks/useWeekData.ts
const [employees, setEmployees] = useState<any[]>([]);
const [projects, setProjects] = useState<any[]>([]);

// lib/client-db.ts
export async function saveWeekAchievements(year: number, week: number, events: any[])
```

#### After
```typescript
// hooks/useWeekData.ts
const [employees, setEmployees] = useState<ClientEmployee[]>([]);
const [projects, setProjects] = useState<ClientProject[]>([]);

// lib/client-db.ts
export async function saveWeekAchievements(year: number, week: number, events: ServerEvent[])
```

### 2. 厳密な型チェック

#### Before
```typescript
// page.tsx
const [selectedEvent, setSelectedEvent] = useState<any>(null);
const handleEventClick = (event: any) => {
  setSelectedEvent(event);
};
```

#### After
```typescript
// page.tsx
const [selectedEvent, setSelectedEvent] = useState<ClientEvent | null>(null);
const handleEventClick = (event: ClientEvent) => {
  setSelectedEvent(event);
};
```

## 🚀 実装計画

### Phase 1: 基本型定義の作成
1. **`types/base.ts`** - 共通ベース型の定義
2. **`types/server.ts`** - サーバーサイド型の定義
3. **`types/client.ts`** - クライアントサイド型の定義
4. **`types/ui.ts`** - UI状態型の定義
5. **`types/data.ts`** - データ状態型の定義
6. **`types/api.ts`** - API型の定義

### Phase 2: 型変換ユーティリティの作成
1. **`utils/typeConverters.ts`** - イベント変換関数
2. **`utils/workTimeConverters.ts`** - 勤務時間変換関数
3. **`utils/colorUtils.ts`** - 色関連ユーティリティ

### Phase 3: 既存コードの型置き換え
1. **hooks/useWeekData.ts** - `any[]` → 具体的な型
2. **hooks/useWorkTimes.ts** - `any` → `ClientWorkTime`
3. **lib/client-db.ts** - `any[]` → `ServerEvent[]`
4. **components/TimeGrid.tsx** - `any[]` → `ClientEvent[]`
5. **page.tsx** - `any` → 具体的な型

### Phase 4: 型安全性の検証
1. **TypeScriptコンパイルエラーの修正**
2. **型チェックの追加**
3. **ランタイム型検証の実装**

## 📝 移行ガイドライン

### 1. 段階的移行
- 一度に全ての型を変更せず、段階的に移行
- 各段階でTypeScriptコンパイルエラーを修正
- 既存の機能が正常に動作することを確認

### 2. 後方互換性の維持
- 既存のAPIレスポンスとの互換性を保つ
- ローカルストレージのデータ形式との互換性を保つ
- 段階的な型変換を実装

### 3. テストの追加
- 型変換関数の単体テスト
- 型安全性の検証テスト
- 既存機能の動作確認テスト

## 🎯 期待される効果

### 1. 型安全性の向上
- コンパイル時のエラー検出
- ランタイムエラーの削減
- IDEの自動補完機能の向上

### 2. 保守性の向上
- 型定義の一元化
- 重複コードの削除
- 型の不整合の解消

### 3. 開発効率の向上
- 型推論による開発支援
- リファクタリングの安全性向上
- ドキュメントとしての型定義

この型整理仕様書に基づいて、段階的に型安全性を向上させ、保守性の高いコードベースを構築できます。 