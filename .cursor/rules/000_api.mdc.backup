---
alwaysApply: true
---
# ãƒ«ãƒ¼ãƒ«å:
 APIã®è¨­è¨ˆ

# Persona:

# Context:
 [tRPC](mdc:https:/trpc.io)ã¯ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®å‹å®‰å…¨ãªAPIã‚’å¯èƒ½ã«ã—ã€ã‚¹ã‚­ãƒ¼ãƒã€ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã€ã¾ãŸã¯ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼ãªã—ã§APIã‚’æ§‹ç¯‰ãƒ»æ¶ˆè²»ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒ«ã¯ã€tRPC v11ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«å¾“ã„ã€**createTRPCReact + æ‰‹å‹•Providerè¨­å®š**ã‚’ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‘ã‘ã§ã™ã€‚

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 
æ¨å¥¨ã•ã‚Œã‚‹tRPCã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ§‹é€ ï¼š
```md
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ app
â”‚   â”‚   â”œâ”€â”€ api
â”‚   â”‚   â”‚   â””â”€â”€ trpc
â”‚   â”‚   â”‚       â””â”€â”€ [trpc]
â”‚   â”‚   â”‚           â””â”€â”€ route.ts  # tRPC HTTPãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ã¿
â”‚   â”‚   â””â”€â”€ layout.tsx  # TRPCProviderã‚’ã“ã“ã«é…ç½®
â”‚   â”œâ”€â”€ lib
â”‚   â”‚   â”œâ”€â”€ trpc
â”‚   â”‚   â”‚   â”œâ”€â”€ client.ts      # createTRPCReactè¨­å®š
â”‚   â”‚   â”‚   â”œâ”€â”€ Provider.tsx   # æ‰‹å‹•Providerè¨­å®š
â”‚   â”‚   â”‚   â”œâ”€â”€ trpc.ts        # ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ãƒ˜ãƒ«ãƒ‘ãƒ¼
â”‚   â”‚   â”‚   â””â”€â”€ routers
â”‚   â”‚   â”‚       â”œâ”€â”€ _app.ts    # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªãƒ«ãƒ¼ã‚¿ãƒ¼
â”‚   â”‚   â”‚       â”œâ”€â”€ app  
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ [feature].ts # ã‚¢ãƒ—ãƒªãƒšãƒ¼ã‚¸å›ºæœ‰ãƒ«ãƒ¼ã‚¿ãƒ¼
â”‚   â”‚   â”‚       â””â”€â”€ db      
â”‚   â”‚   â”‚           â””â”€â”€ [feature].ts # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å›ºæœ‰ãƒ«ãƒ¼ã‚¿ãƒ¼
â”‚   â”‚   â”‚       
â”‚   â”‚   â””â”€â”€ db/                # ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤
â”‚   â”‚       â”œâ”€â”€ db_advanced.ts
â”‚   â”‚       â”œâ”€â”€ db_connection.ts
â”‚   â”‚       â”œâ”€â”€ db_CRUD.ts
â”‚   â”‚       â”œâ”€â”€ db_DeleteTable.ts
â”‚   â”‚       â””â”€â”€ db_GetData.ts
â”‚   â””â”€â”€ hooks
â”‚       â””â”€â”€ use[Feature]Data.ts # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
```

## ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### tRPCãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®åˆæœŸåŒ–

```typescript
// lib/trpc/trpc.ts
import { initTRPC } from '@trpc/server';
import superjson from 'superjson';
import { ZodError } from 'zod';

export const createTRPCContext = async (opts: { headers: Headers }) => {
  return {
    headers: opts.headers,
  };
};

const t = initTRPC.context<typeof createTRPCContext>().create({
  transformer: superjson,
  errorFormatter({ shape, error }) {
    return {
      ...shape,
      data: {
        ...shape.data,
        zodError:
          error.cause instanceof ZodError ? error.cause.flatten() : null,
      },
    };
  },
});

export const createTRPCRouter = t.router;
export const publicProcedure = t.procedure;
```

### ãƒ«ãƒ¼ã‚¿ãƒ¼ã®ä½œæˆ

```typescript
// lib/trpc/routers/_app.ts
import { createTRPCRouter } from '../trpc';
import { userRouter } from './user';
import { postRouter } from './post';

export const appRouter = createTRPCRouter({
  user: userRouter,
  post: postRouter,
});

export type AppRouter = typeof appRouter;
```

### æ©Ÿèƒ½åˆ¥ãƒ«ãƒ¼ã‚¿ãƒ¼ã®ä½œæˆ

```typescript
// src/lib/trpc/routers/user.ts

/**
 * @file ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆUserï¼‰ã«é–¢é€£ã™ã‚‹APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ï¼‰ã‚’å®šç¾©ã™ã‚‹ãƒ«ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚
 */

import { TRPCError } from '@trpc/server';
import { z } from 'zod';
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œé–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆå®Ÿéš›ã®å®Ÿè£…ã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼‰
import { getRecord, updateRecord, getAllRecords, createRecord } from '@src/lib/db/db_CRUD';
import { createTRPCRouter, publicProcedure } from '../trpc';

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã®ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã‚’ã¾ã¨ã‚ãŸãƒ«ãƒ¼ã‚¿ãƒ¼ã€‚
 * `createTRPCRouter` ã‚’ä½¿ã£ã¦å®šç¾©ã—ã¾ã™ã€‚
 * ã“ã“ã§å®šç¾©ã•ã‚ŒãŸãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã¯ `trpc.user.getAll` ã®ã‚ˆã†ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
 */
export const userRouter = createTRPCRouter({
  /**
   * å…¨ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã€‚
   * .query() ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ã“ã‚Œã¯ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ï¼ˆèª­ã¿å–ã‚Šï¼‰æ“ä½œã§ã™ã€‚
   */
  getAll: publicProcedure
    .query(async () => {
      try {
        // --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ ---
        // å®Ÿéš›ã«ã¯ã“ã“ã§ `getAllRecords('users')` ã®ã‚ˆã†ãªé–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€
        // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ã¾ã™ã€‚
        // const allUsers = await getAllRecords('users');
        // return { success: true, data: allUsers };
        // --------------------

        // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰ã‚’è¿”ã™
        return { success: true, data: [] };
      } catch (error) {
        // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã‚¨ãƒ©ãƒ¼ã‚’ãƒ­ã‚®ãƒ³ã‚°
        console.error("tRPC user.getAll error:", error);
        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¯æ¨™æº–åŒ–ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
        throw new TRPCError({
          code: 'INTERNAL_SERVER_ERROR',
          message: 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ',
        });
      }
    }),

  /**
   * æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã€‚
   * .mutation() ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ã“ã‚Œã¯ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ã™ã‚‹ï¼ˆæ›¸ãè¾¼ã¿ï¼‰æ“ä½œã§ã™ã€‚
   */
  create: publicProcedure
    // .input() ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚
    // z (Zod) ã‚’ä½¿ã£ã¦ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«ã‚’æŒ‡å®šã—ã¾ã™ã€‚
    .input(z.object({
      name: z.string().min(1, 'åå‰ã¯å¿…é ˆã§ã™'),
      email: z.string().email('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'),
      age: z.number().min(0, 'å¹´é½¢ã¯0ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™'),
    }))
    // mutationã®å¼•æ•°ã‹ã‚‰æ¤œè¨¼æ¸ˆã¿ã® `input` ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
    .mutation(async ({ input }) => {
      try {
        // --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ ---
        // æ¤œè¨¼æ¸ˆã¿ã® `input` ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚
        // const newUser = await createRecord('users', input);
        // return { success: true, data: newUser };
        // --------------------

        // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰ã‚’è¿”ã™
        return { success: true, data: input };
      } catch (error) {
        console.error("tRPC user.create error:", error);
        throw new TRPCError({
          code: 'INTERNAL_SERVER_ERROR',
          message: 'ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ',
        });
      }
    }),

  /**
   * æ¡ä»¶ã‚’æŒ‡å®šã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢ã™ã‚‹ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã€‚
   * .query() ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ã“ã‚Œã‚‚ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹æ“ä½œã§ã™ã€‚
   */
  search: publicProcedure
    // æ¤œç´¢æ¡ä»¶ã‚’ .input() ã§å®šç¾©ã—ã¾ã™ã€‚
    // .optional() ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§ã€ãã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒçœç•¥å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
    .input(z.object({
      name: z.string().optional(),
      email: z.string().optional(),
    }))
    // queryã®å¼•æ•°ã‹ã‚‰æ¤œè¨¼æ¸ˆã¿ã® `input` (æ¤œç´¢æ¡ä»¶) ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
    .query(async ({ input }) => {
      try {
        // --- æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ ---
        // `input.name` ã‚„ `input.email` ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ¤œç´¢ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«å®Ÿè£…ã—ã¾ã™ã€‚
        // const searchedUsers = await searchRecords('users', input);
        // return { success: true, data: searchedUsers };
        // ------------------
        // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰ã‚’è¿”ã™
        return { success: true, data: [] };
      } catch (error) {
        console.error("tRPC user.search error:", error);
        throw new TRPCError({
          code: 'INTERNAL_SERVER_ERROR',
          message: 'æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ',
        });
      }
    }),
});
```

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### createTRPCReactè¨­å®š

```typescript
// lib/trpc/client.ts
import { createTRPCReact } from '@trpc/react-query';

import type { AppRouter } from './routers/_app';

export const trpc = createTRPCReact<AppRouter>();
```

### æ‰‹å‹•Providerè¨­å®š

```typescript
// lib/trpc/Provider.tsx
'use client';

import { httpBatchLink } from '@trpc/client';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import React, { useState } from 'react';
import superjson from 'superjson';

import { trpc } from './client';

function getBaseUrl() {
  if (typeof window !== 'undefined') return '';
  if (process.env.VERCEL_URL) return `https://${process.env.VERCEL_URL}`;
  return `http://localhost:${process.env.PORT ?? 3000}`;
}

export function TRPCProvider({ children }: { children: React.ReactNode }) {
  const [queryClient] = useState(() => new QueryClient());
  const [trpcClient] = useState(() =>
    trpc.createClient({
      links: [
        httpBatchLink({
          url: `${getBaseUrl()}/api/trpc`,
          transformer: superjson,
        }),
      ],
    }),
  );

  return (
    <trpc.Provider client={trpcClient} queryClient={queryClient}>
      <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
    </trpc.Provider>
  );
}
```

### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ã®Provideré…ç½®

```typescript
// app/layout.tsx
import { TRPCProvider } from '@src/lib/trpc/Provider';

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <body>
        <TRPCProvider>
          {children}
        </TRPCProvider>
      </body>
    </html>
  );
}
```

## ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ï¼ˆDALï¼‰ã®çµ±ä¸€

### ğŸ“ åˆ©ç”¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¿…ãšåˆ©ç”¨ã™ã‚‹:
- `src/lib/db/db_advanced.ts`
- `src/lib/db/db_connection.ts`
- `src/lib/db/db_CRUD.ts`
- `src/lib/db/db_DeleteTable.ts`
- `src/lib/db/db_GetData.ts`

### ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ã®æ§‹é€ åŒ–
ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ï¼ˆDALï¼‰ã¯ã€ä»¥ä¸‹ã®æ§‹é€ ã§æ•´ç†ã™ã‚‹ã“ã¨:

#### ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ
```md
src/lib/db/
â”œâ”€â”€ queries/              # ç‰¹æ®Šãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å«ã‚€ã‚¯ã‚¨ãƒªé–¢æ•°
â”‚   â”œâ”€â”€ userQueries.ts         # ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã®ç‰¹æ®Šã‚¯ã‚¨ãƒª
â”‚   â”œâ”€â”€ projectMemberQueries.ts # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ãƒ³ãƒãƒ¼é–¢é€£ã®ç‰¹æ®Šã‚¯ã‚¨ãƒª
â”‚   â””â”€â”€ [feature]Queries.ts     # æ©Ÿèƒ½åˆ¥ã®ç‰¹æ®Šã‚¯ã‚¨ãƒª
â”œâ”€â”€ crud/                 # æ±ç”¨CRUDæ“ä½œé–¢æ•°
â”‚   â”œâ”€â”€ db_CRUD.ts
â”‚   â”œâ”€â”€ db_GetData.ts
â”‚   â””â”€â”€ db_advanced.ts
â”œâ”€â”€ connection/           # DBæ¥ç¶šé–¢é€£
â”‚   â””â”€â”€ db_connection.ts
â””â”€â”€ [ãã®ä»–ã®æ±ç”¨ãƒ•ã‚¡ã‚¤ãƒ«]
```

#### æ•´ç†ã®åŸå‰‡
1. **æ±ç”¨é–¢æ•°ã¨ç‰¹æ®Šé–¢æ•°ã‚’åˆ†é›¢**: `queries/`ãƒ•ã‚©ãƒ«ãƒ€ã«è¤‡é›‘ãªJOINã‚„ç‰¹æ®Šãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’é›†ç´„
2. **æ©Ÿèƒ½åˆ¥ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°**: é–¢é€£ã™ã‚‹ã‚¯ã‚¨ãƒªã‚’1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‹
3. **å†åˆ©ç”¨æ€§ã®ç¢ºä¿**: è¤‡æ•°ã®ç®‡æ‰€ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚¯ã‚¨ãƒªã¯`queries/`ã«é…ç½®
4. **ä¿å®ˆæ€§ã®å‘ä¸Š**: æ±ç”¨é–¢æ•°ã¨ç‰¹æ®Šé–¢æ•°ã®å½¹å‰²ã‚’æ˜ç¢ºã«åˆ†é›¢

#### ä½¿ç”¨ä¾‹
```typescript
// âœ… è‰¯ã„ä¾‹ï¼šæ±ç”¨CRUDé–¢æ•°
import { getAllRecords, createRecord } from '../crud/db_CRUD';

// âœ… è‰¯ã„ä¾‹ï¼šç‰¹æ®Šã‚¯ã‚¨ãƒªé–¢æ•°
import { getProjectMembers } from '../queries/projectMemberQueries';

// âŒ é¿ã‘ã‚‹ã¹ãä¾‹ï¼šç›´æ¥DBæ“ä½œã‚’tRPCãƒ«ãƒ¼ã‚¿ãƒ¼ã«è¨˜è¿°
const result = await db.raw('SELECT * FROM users u LEFT JOIN projects p ON ...');
```

### ğŸ”„ æˆ»ã‚Šå€¤ã®çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
DB ã‚¢ã‚¯ã‚»ã‚¹é–¢æ•°ï¼ˆä¾‹: `getRecord()`, `updateById()` ãªã©ï¼‰ã¯ã€æˆ»ã‚Šå€¤ã«å¿…ãšä»¥ä¸‹ã®æ§‹é€ ã‚’å«ã‚ã‚‹:

```typescript
// æˆåŠŸæ™‚
{
  success: true,
  data: T
}

// å¤±æ•—æ™‚  
{
  success: false,
  error: {
    code: string,
    message: string
  }
}
```

### ğŸš« ä¾‹å¤–å‡¦ç†ã®æ–¹é‡
- DAL å´ã§ `success: false` ã¨ãªã£ãŸå ´åˆã¯**ä¾‹å¤–ã‚’æŠ•ã’ãªã„**
- å‘¼ã³å‡ºã—å…ƒã® tRPC ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã§ `TRPCError` ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦è¿”å´ã™ã‚‹

### ğŸ”§ ORMä½¿ç”¨æ™‚ã®æ³¨æ„
Prismaãƒ»Knexãƒ»TypeORM ãªã©ã® ORM ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã‚‚ã€ã€ŒçµæœãŒå–å¾—ã§ããŸã‹/ã§ããªã‹ã£ãŸã‹ã€ã®åˆ¤å®šã‚’è¡Œã†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’å¿…ãšæŒŸã‚€ã€‚

#### å®Ÿè£…ä¾‹:
```typescript
// src/lib/db/db_CRUD.ts
export async function getRecord<T>(table: string, id: number): Promise<DALResponse<T>> {
  try {
    const result = await db(table).where('id', id).first();
    
    if (!result) {
      return {
        success: false,
        error: {
          code: 'RECORD_NOT_FOUND',
          message: `Record with id ${id} not found in ${table}`
        }
      };
    }
    
    return {
      success: true,
      data: result as T
    };
  } catch (error) {
    return {
      success: false,
      error: {
        code: 'DATABASE_ERROR',
        message: error instanceof Error ? error.message : 'Unknown database error'
      }
    };
  }
}
```

## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã«ã‚ˆã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã®é›†ç´„
tRPCã®ãƒ‡ãƒ¼ã‚¿æ“ä½œï¼ˆQueryã‚„Mutationï¼‰ã¯ã€é–¢é€£ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ©Ÿèƒ½ï¼‰ã”ã¨ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã¸é›†ç´„ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®é–¢å¿ƒã‚’UIã«é›†ä¸­ã•ã›ã€ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†åˆ©ç”¨ã—ã‚„ã™ãã—ã¾ã™ã€‚
#### å‘½åè¦å‰‡
 - ãƒ•ã‚¡ã‚¤ãƒ«å: hooks/use{TableName}Data.ts ä¾‹: hooks/useUserData.ts, hooks/usePostData.ts
 - ãƒ•ãƒƒã‚¯å: use{TableName}Data ä¾‹: useUserData, usePostData

```typescript
// hooks/useFeatureData.ts
import { trpc } from '@src/lib/trpc/client';

export const useFeatureAll = () => {
  return trpc.feature.getAll.useQuery();
};

export const useFeatureSearch = (filters: Record<string, any>) => {
  return trpc.feature.search.useQuery(filters, {
    enabled: Object.values(filters).some(value => value && value.length > 0)
  });
};

export const useFeatureMutations = () => {
  const utils = trpc.useUtils();
  
  const createMutation = trpc.feature.create.useMutation({
    onSuccess: () => {
      void utils.feature.getAll.invalidate();
      void utils.feature.search.invalidate();
    }
  });

  const updateMutation = trpc.feature.update.useMutation({
    onSuccess: () => {
      void utils.feature.getAll.invalidate();
      void utils.feature.search.invalidate();
    }
  });

  const deleteMutation = trpc.feature.delete.useMutation({
    onSuccess: () => {
      void utils.feature.getAll.invalidate();
      void utils.feature.search.invalidate();
    }
  });

  return { createMutation, updateMutation, deleteMutation };
};
```

### 2. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®ä½¿ç”¨

```tsx
// components/FeatureComponent.tsx
'use client';

import { useState } from 'react';
import { trpc } from '@src/lib/trpc/client';
import { useFeatureMutations } from '@src/hooks/useFeatureData';

export function FeatureComponent() {
  const { data: allData, isLoading } = trpc.feature.getAll.useQuery();
  const { createMutation, updateMutation, deleteMutation } = useFeatureMutations();
  const utils = trpc.useUtils();

  const handleCreate = (formData: any) => {
    createMutation.mutate(formData);
  };

  const handleUpdate = (id: number, updates: any) => {
    updateMutation.mutate({ id, data: updates });
  };

  const handleDelete = (id: number) => {
    if (confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      deleteMutation.mutate({ id });
    }
  };

  return (
    <div>
      {/* UIå®Ÿè£… */}
    </div>
  );
}
```

### 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```typescript
// çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼
export const createTRPCRouter = t.router;
export const publicProcedure = t.procedure;

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ããƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£
export const safeProcedure = publicProcedure.use(async ({ next, ctx }) => {
  try {
    return await next({ ctx });
  } catch {
    throw new TRPCError({
      code: 'INTERNAL_SERVER_ERROR',
      message: 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
    });
  }
});
```

### 4. å‹å®‰å…¨æ€§ã®ç¢ºä¿

```typescript
import { z } from 'zod';

// types/feature.ts
export interface Feature {
  id: number;
  name: string;
  description?: string;
  created_at?: string;
  updated_at?: string;
}

// Zodã‚¹ã‚­ãƒ¼ãƒ

export const FeatureSchema = z.object({
  name: z.string().min(1, 'åå‰ã¯å¿…é ˆã§ã™'),
  description: z.string().optional(),
});
```

### 5. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

```typescript
// ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–
const { data, isLoading } = trpc.feature.getAll.useQuery(undefined, {
  staleTime: 5 * 60 * 1000, // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  cacheTime: 10 * 60 * 1000, // 10åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿æŒ
});

// æ¡ä»¶ä»˜ãã‚¯ã‚¨ãƒª
const { data: searchData } = trpc.feature.search.useQuery(
  searchFilters,
  { 
    enabled: Object.values(searchFilters).some(value => value && value.length > 0),
    refetchOnWindowFocus: false,
  }
);
```


## ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡

- **ãƒ«ãƒ¼ã‚¿ãƒ¼**: `[feature].ts` (ä¾‹: `user.ts`, `post.ts`)
- **ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯**: `use[Feature]Data.ts` (ä¾‹: `useUserData.ts`, `usePostData.ts`)
- **ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: `[Feature]TRPCTest.tsx` (ä¾‹: `UserTRPCTest.tsx`, `PostTRPCTest.tsx`)
- **ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸**: `test-[feature]-trpc/page.tsx` (ä¾‹: `test-user-trpc/page.tsx`)
- **ç‰¹æ®Šã‚¯ã‚¨ãƒªé–¢æ•°**: `[feature]Queries.ts` (ä¾‹: `userQueries.ts`, `projectMemberQueries.ts`)
- **æ±ç”¨CRUDé–¢æ•°**: `db_[function].ts` (ä¾‹: `db_CRUD.ts`, `db_GetData.ts`)

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼

```typescript
// æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
{
  success: true,
  data: any,
  message?: string
}

// ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
{
  success: false,
  error: {
    code: string,
    message: string,
    details?: any
  }
}
```

### ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰

- `BAD_REQUEST`: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å½¢å¼ãŒä¸æ­£
- `UNAUTHORIZED`: èªè¨¼ãŒå¿…è¦
- `FORBIDDEN`: ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãªã—
- `NOT_FOUND`: ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„
- `INTERNAL_SERVER_ERROR`: ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã‚¨ãƒ©ãƒ¼

## å…±é€šãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³

### CRUDæ“ä½œã®æ¨™æº–ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
export const featureRouter = createTRPCRouter({
  // å…¨ä»¶å–å¾—
  getAll: publicProcedure
    .query(async () => {
      try {
        // DALå±¤ã‚’ä½¿ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿å–å¾—
        const result = await getAllRecords('features');
        
        if (!result.success) {
          throw new TRPCError({
            code: 'INTERNAL_SERVER_ERROR',
            message: result.error?.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ',
          });
        }
        
        return { success: true, data: result.data };
      } catch {
        throw new TRPCError({
          code: 'INTERNAL_SERVER_ERROR',
          message: 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ',
        });
      }
    }),

  // IDæŒ‡å®šå–å¾—
  getById: publicProcedure
    .input(z.object({ id: z.number() }))
    .query(async ({ input }) => {
      try {
        const result = await getRecord('features', input.id);
        
        if (!result.success) {
          throw new TRPCError({
            code: 'NOT_FOUND',
            message: result.error?.message || 'ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
          });
        }
        
        return { success: true, data: result.data };
      } catch {
        throw new TRPCError({
          code: 'INTERNAL_SERVER_ERROR',
          message: 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ',
        });
      }
    }),

  // æ¤œç´¢
  search: publicProcedure
    .input(z.object({
      // æ¤œç´¢æ¡ä»¶
    }))
    .query(async ({ input }) => {
      try {
        // æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯
        return { success: true, data: [] };
      } catch {
        throw new TRPCError({
          code: 'INTERNAL_SERVER_ERROR',
          message: 'æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ',
        });
      }
    }),

  // ä½œæˆ
  create: publicProcedure
    .input(FeatureSchema)
    .mutation(async ({ input }) => {
      try {
        const result = await createRecord('features', input);
        
        if (!result.success) {
          throw new TRPCError({
            code: 'INTERNAL_SERVER_ERROR',
            message: result.error?.message || 'ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ',
          });
        }
        
        return { success: true, data: result.data };
      } catch {
        throw new TRPCError({
          code: 'INTERNAL_SERVER_ERROR',
          message: 'ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ',
        });
      }
    }),

  // æ›´æ–°
  update: publicProcedure
    .input(z.object({
      id: z.number(),
      data: FeatureSchema.partial(),
    }))
    .mutation(async ({ input }) => {
      try {
        const result = await updateRecord('features', input.id, input.data);
        
        if (!result.success) {
          throw new TRPCError({
            code: 'NOT_FOUND',
            message: result.error?.message || 'ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
          });
        }
        
        return { success: true, data: result.data };
      } catch {
        throw new TRPCError({
          code: 'INTERNAL_SERVER_ERROR',
          message: 'ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ',
        });
      }
    }),

  // å‰Šé™¤
  delete: publicProcedure
    .input(z.object({ id: z.number() }))
    .mutation(async ({ input }) => {
      try {
        const result = await deleteRecord('features', input.id);
        
        if (!result.success) {
          throw new TRPCError({
            code: 'NOT_FOUND',
            message: result.error?.message || 'ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
          });
        }
        
        return { success: true, data: result.data };
      } catch {
        throw new TRPCError({
          code: 'INTERNAL_SERVER_ERROR',
          message: 'ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ',
        });
      }
    }),
});
```

## ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…

### Zodã‚¹ã‚­ãƒ¼ãƒã«ã‚ˆã‚‹å…¥åŠ›æ¤œè¨¼

```typescript
// åŸºæœ¬ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
const UserSchema = z.object({
  name: z.string().min(1, 'åå‰ã¯å¿…é ˆã§ã™'),
  email: z.string().email('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'),
  age: z.number().min(0, 'å¹´é½¢ã¯0ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™'),
});

// æ¡ä»¶ä»˜ããƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
const ConditionalSchema = z.object({
  type: z.enum(['admin', 'user']),
  permissions: z.array(z.string()).optional(),
}).refine((data) => {
  if (data.type === 'admin' && (!data.permissions || data.permissions.length === 0)) {
    return false;
  }
  return true;
}, {
  message: 'ç®¡ç†è€…ã®å ´åˆã¯æ¨©é™ã‚’æŒ‡å®šã—ã¦ãã ã•ã„',
});

// ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
const CustomValidationSchema = z.object({
  password: z.string().min(8, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™'),
  confirmPassword: z.string(),
}).refine((data) => data.password === data.confirmPassword, {
  message: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“',
  path: ['confirmPassword'],
});
```

## ãƒ­ã‚°å‡ºåŠ›ã®çµ±ä¸€

### ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®å‡ºåŠ›

```typescript
// ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£å†…ã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
export const userRouter = createTRPCRouter({
  getById: publicProcedure
    .input(z.object({ id: z.number() }))
    .query(async ({ input }) => {
      try {
        const result = await getRecord('users', input.id);
        
        if (!result.success) {
          throw new TRPCError({
            code: 'NOT_FOUND',
            message: result.error?.message || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
          });
        }
        
        return { success: true, data: result.data };
      } catch {
        throw new TRPCError({
          code: 'INTERNAL_SERVER_ERROR',
          message: 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ',
        });
      }
    }),
});
```

## å‹å®‰å…¨æ€§ã®ç¢ºä¿

### å‹å®šç¾©ã®çµ±ä¸€

```typescript
// types/api.ts
export type ApiSuccess<T> = {
  success: true;
  data: T;
};

export type ApiError = {
  success: false;
  error: {
    code: string;
    message: string;
    status?: number;
  };
};

export type ApiResponse<T> = ApiSuccess<T> | ApiError;

// DALå±¤ã®å‹å®šç¾©
export interface DALResponse<T> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
  };
}
```

## ğŸš¨ é¿ã‘ã‚‹ã¹ããƒ‘ã‚¿ãƒ¼ãƒ³

- âŒ **DALå±¤ã§ä¾‹å¤–ã‚’æŠ•ã’ã‚‹**
- âŒ **çµ±ä¸€ã•ã‚Œã¦ã„ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼**
- âŒ **é©åˆ‡ã§ãªã„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
- âŒ **å‹å®‰å…¨æ€§ã‚’ç„¡è¦–ã—ãŸå®Ÿè£…**
- âŒ **ä¸é©åˆ‡ãªãƒ­ã‚°å‡ºåŠ›**
- âŒ **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çœç•¥ã™ã‚‹**
- âŒ **DALå±¤ã®é–¢æ•°ã‚’ç›´æ¥å‘¼ã³å‡ºã•ãªã„**
- âŒ **ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’çµ±ä¸€ã—ãªã„**
- âŒ **transformerã‚’createClientã®ç›´æ¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«æŒ‡å®šã™ã‚‹**
- âŒ **æ©Ÿèƒ½åˆ¥ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’HTTPãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¨åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã™ã‚‹**
- âŒ **process.envã‚’ç›´æ¥ä½¿ç”¨ã™ã‚‹**
- âŒ **æ±ç”¨é–¢æ•°ã¨ç‰¹æ®Šã‚¯ã‚¨ãƒªé–¢æ•°ã‚’åŒã˜éšå±¤ã«æ··åœ¨ã•ã›ã‚‹**
- âŒ **è¤‡é›‘ãªJOINã‚’tRPCãƒ«ãƒ¼ã‚¿ãƒ¼å†…ã«ç›´æ¥è¨˜è¿°ã™ã‚‹**

## ğŸ“‹ å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] çµ±ä¸€ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹
- [ ] é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] DALå±¤ã®é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹
- [ ] å‹å®‰å…¨æ€§ãŒç¢ºä¿ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] Zodã‚¹ã‚­ãƒ¼ãƒã«ã‚ˆã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãŒçµ±ä¸€ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] transformerãŒhttpBatchLinkã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] æ©Ÿèƒ½åˆ¥ãƒ«ãƒ¼ã‚¿ãƒ¼ãŒHTTPãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¨åˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ç’°å¢ƒå¤‰æ•°ãŒå‹å®‰å…¨ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ãŒqueries/crud/connectionã§æ•´ç†ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] æ±ç”¨é–¢æ•°ã¨ç‰¹æ®Šã‚¯ã‚¨ãƒªé–¢æ•°ãŒé©åˆ‡ã«åˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ã‹

## ãƒãƒ¼ã‚¸ãƒ§ãƒ³äº’æ›æ€§

ã“ã®ã‚¬ã‚¤ãƒ‰ã¯tRPC v11ç”¨ã§ã€ä»¥ä¸‹ãŒå¿…è¦ã§ã™ï¼š
- TypeScript >= 5.7.2
- @trpc/react-query >= 11.4.3
- @tanstack/react-query >= 5.81.5
- å³å¯†ãªTypeScriptãƒ¢ãƒ¼ãƒ‰ï¼ˆtsconfig.jsonã§`"strict": true`ï¼‰

## ç’°å¢ƒå¤‰æ•°ã®å‹å®‰å…¨æ€§

### ğŸš¨ é‡è¦ãªæ³¨æ„äº‹é …

**`process.env`ã‚’ç›´æ¥ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯é¿ã‘ã¦ãã ã•ã„ã€‚** ç’°å¢ƒå¤‰æ•°ã®å‹å®‰å…¨æ€§ã‚’ä¿è¨¼ã™ã‚‹ãŸã‚ã«ã€Zodã‚’ä½¿ç”¨ã—ãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¿…ãšå®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

### ç’°å¢ƒå¤‰æ•°ã‚¹ã‚­ãƒ¼ãƒã®å®šç¾©

```typescript
// lib/env.ts
import { z } from 'zod';

const envSchema = z.object({
  // å¿…é ˆç’°å¢ƒå¤‰æ•°
  NODE_ENV: z.enum(['development', 'production', 'test']),
  PORT: z.string().transform((val) => parseInt(val, 10)),
  
  // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç’°å¢ƒå¤‰æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ä»˜ãï¼‰
  VERCEL_URL: z.string().optional(),
  NEXT_PUBLIC_API_BASE_URL: z.string().optional().default(''),
  
  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£
  DATABASE_URL: z.string().url('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URLã‚’æŒ‡å®šã—ã¦ãã ã•ã„'),
  
  // èªè¨¼é–¢é€£
  JWT_SECRET: z.string().min(32, 'JWT_SECRETã¯32æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™'),
  
  // å¤–éƒ¨APIé–¢é€£
  EXTERNAL_API_KEY: z.string().optional(),
  EXTERNAL_API_URL: z.string().url().optional(),
});

// ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼ã¨å‹å®‰å…¨ãªå–å¾—
export const env = envSchema.parse(process.env);

// å‹å®šç¾©ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
export type Env = z.infer<typeof envSchema>;
```

### ç’°å¢ƒå¤‰æ•°ä½¿ç”¨ã®å®Ÿè£…ä¾‹

```typescript
// lib/trpc/Provider.tsx
'use client';

import { httpBatchLink } from '@trpc/client';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import React, { useState } from 'react';
import superjson from 'superjson';
import { env } from '@src/lib/env';
import { trpc } from './client';

function getBaseUrl() {
  if (typeof window !== 'undefined') return '';
  
  // å‹å®‰å…¨ãªç’°å¢ƒå¤‰æ•°ã‚¢ã‚¯ã‚»ã‚¹
  if (env.VERCEL_URL) return `https://${env.VERCEL_URL}`;
  return `http://localhost:${env.PORT}`;
}

export function TRPCProvider({ children }: { children: React.ReactNode }) {
  const [queryClient] = useState(() => new QueryClient());
  const [trpcClient] = useState(() =>
    trpc.createClient({
      links: [
        httpBatchLink({
          url: `${getBaseUrl()}/api/trpc`,
          transformer: superjson,
        }),
      ],
    }),
  );

  return (
    <trpc.Provider client={trpcClient} queryClient={queryClient}>
      <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
    </trpc.Provider>
  );
}
```

### APIè¨­å®šã§ã®ä½¿ç”¨ä¾‹

```typescript
// lib/apiRequest.ts
import axios, { AxiosError, AxiosRequestConfig, Method } from 'axios';
import { NextRequest } from 'next/server';

import { env } from '@src/lib/env';

const api = axios.create({
  // å‹å®‰å…¨ãªç’°å¢ƒå¤‰æ•°ã‚¢ã‚¯ã‚»ã‚¹
  baseURL: env.NEXT_PUBLIC_API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
  withCredentials: true,
});

api.interceptors.response.use(
  (res) => res,
  (error: AxiosError) => {
    console.error('API error:', error);
    if (error.response?.status === 401) {
      console.warn('401: èªè¨¼ã‚¨ãƒ©ãƒ¼');
    }
    return Promise.reject(error);
  }
);

export default api;
```

### é–‹ç™ºç’°å¢ƒã§ã®ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯

```typescript
// lib/env.ts
import { z } from 'zod';

const envSchema = z.object({
  // ... ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
});

// é–‹ç™ºç’°å¢ƒã§ã®ã¿ç’°å¢ƒå¤‰æ•°ã‚’ãƒã‚§ãƒƒã‚¯
if (process.env.NODE_ENV === 'development') {
  try {
    envSchema.parse(process.env);
    console.log('âœ… ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸ');
  } catch (error) {
    console.error('âŒ ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
    process.exit(1);
  }
}

export const env = envSchema.parse(process.env);
```

### ç’°å¢ƒå¤‰æ•°ã®å‹å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] `process.env`ã‚’ç›´æ¥ä½¿ç”¨ã—ã¦ã„ãªã„ã‹
- [ ] Zodã‚¹ã‚­ãƒ¼ãƒã§ç’°å¢ƒå¤‰æ•°ã‚’å®šç¾©ã—ã¦ã„ã‚‹ã‹
- [ ] å¿…é ˆç’°å¢ƒå¤‰æ•°ãŒé©åˆ‡ã«æ¤œè¨¼ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç’°å¢ƒå¤‰æ•°ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] é–‹ç™ºç’°å¢ƒã§ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã‹
- [ ] å‹å®‰å…¨ãªç’°å¢ƒå¤‰æ•°ã‚¢ã‚¯ã‚»ã‚¹ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ç’°å¢ƒå¤‰æ•°ã®å€¤ãŒé©åˆ‡ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã•ã‚Œã¦ã„ã‚‹ã‹

### ğŸš« é¿ã‘ã‚‹ã¹ããƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
// âŒ æ‚ªã„ä¾‹ï¼šç›´æ¥çš„ãªprocess.envä½¿ç”¨
function getBaseUrl() {
  if (process.env.VERCEL_URL) return `https://${process.env.VERCEL_URL}`;
  return `http://localhost:${process.env.PORT ?? 3000}`; // å‹å®‰å…¨æ€§ãªã—
}

// âŒ æ‚ªã„ä¾‹ï¼šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—
const api = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_BASE_URL || '', // å‹å®‰å…¨æ€§ãªã—
});

// âŒ æ‚ªã„ä¾‹ï¼štransformerã®é–“é•ã£ãŸæŒ‡å®šå ´æ‰€
trpc.createClient({
  transformer: superjson, // âŒ ã“ã“ã§ã¯ãªã
  links: [
    httpBatchLink({
      url: `${getBaseUrl()}/api/trpc`,
    }),
  ],
});
```

### âœ… æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
// âœ… è‰¯ã„ä¾‹ï¼šå‹å®‰å…¨ãªç’°å¢ƒå¤‰æ•°ã‚¢ã‚¯ã‚»ã‚¹
import { env } from '@src/lib/env';

function getBaseUrl() {
  if (env.VERCEL_URL) return `https://${env.VERCEL_URL}`;
  return `http://localhost:${env.PORT}`; // å‹å®‰å…¨
}

const api = axios.create({
  baseURL: env.NEXT_PUBLIC_API_BASE_URL, // å‹å®‰å…¨
});

// âœ… è‰¯ã„ä¾‹ï¼štransformerã®æ­£ã—ã„æŒ‡å®šå ´æ‰€
trpc.createClient({
  links: [
    httpBatchLink({
      url: `${getBaseUrl()}/api/trpc`,
      transformer: superjson, // âœ… ã“ã“
    }),
  ],
});
```

## ãã®ä»–ã®ãƒªã‚½ãƒ¼ã‚¹

- [tRPCå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](mdc:https:/trpc.io/docs)
- [React Queryå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](mdc:https:/tanstack.com/query/latest)
- [Zodå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](mdc:https:/zod.dev)






