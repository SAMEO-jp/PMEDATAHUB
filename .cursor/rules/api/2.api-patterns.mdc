---
description: 
globs: 
alwaysApply: false
---
---
description: "Next.js ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã® API å®Ÿè£…ãƒ»ä½¿ç”¨ãƒ«ãƒ¼ãƒ«ï¼ˆNext.js + Axios æ§‹æˆï¼‰"
globs:
  - "src/app/api/**"
  - "src/lib/apiRequest.ts"
  - "src/hooks/useApi*.ts"
alwaysApply: false
---
# å«ã¶å±¤
- èª­ã¿è¾¼ã‚“ã ã‚‰ã€Œã¯!!!api-patterns.mdc!!!ã€ã¨å«ã¶

# API ä½œæˆãƒ»ä½¿ç”¨ãƒ«ãƒ¼ãƒ«ï¼ˆNext.js + Axios æ§‹æˆï¼‰


## âœ… API ä½œæˆæ™‚ã®ãƒ«ãƒ¼ãƒ«ï¼ˆroute.tsï¼‰

ã©ã®ãƒšãƒ¼ã‚¸ã®ç‚ºã«ä½œã£ãŸAPIã‹ã‚’è¨˜è¿°ã™ã‚‹ã€‚
ã¾ãŸã€ä½œæˆæ™‚ã§ãªãã€å‚ç…§æ™‚å…ˆãŒå¢—ãˆã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Œã°ã€ãã®ãƒšãƒ¼ã‚¸ã«ã¤ã„ã¦ã‚‚ãƒ¡ãƒ¢ã™ã‚‹ã€‚

- `app/api/[...]/route.ts` å½¢å¼ã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®šç¾©ã™ã‚‹ã€‚
- `GET`/`POST`/`PUT`/`DELETE` ãªã©ã® HTTP ãƒ¡ã‚½ãƒƒãƒ‰ã”ã¨ã«

```ts
export async function GET(req: Request) { â€¦ }
export async function POST(req: Request) { â€¦ }
// ãªã©
```

ã‚’å¿…ãšæ˜ç¤ºã™ã‚‹ã€‚

* ãƒªã‚¯ã‚¨ã‚¹ãƒˆæœ¬æ–‡ã®ãƒ‘ãƒ¼ã‚¹ (`await req.json()`) ã‚„ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å–å¾— (`new URL(req.url).searchParams`) ã¯è‡ªå‰ã§æ›¸ã‹ãšã€`src/lib/apiRequest.ts` å†…ã®å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’åˆ©ç”¨ã™ã‚‹ã€‚
* ä¾‹å¤–å‡¦ç†ã¯å¿…ãš `try/catch` ãƒ–ãƒ­ãƒƒã‚¯ã§è¡Œã„ã€catch å†…ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ã¯çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã€‚
* ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯å¿…ãšä»¥ä¸‹ã®æ§‹é€ ã§è¿”å´ã™ã‚‹:

```ts
import { NextResponse } from "next/server";

// æˆåŠŸæ™‚
return NextResponse.json<ApiResponse<T>>({
  success: true,
  data: yourData
});

// å¤±æ•—æ™‚
return NextResponse.json<ApiResponse<null>>({
  success: false,
  error: {
    code: "YOUR_ERROR_CODE",
    message: "è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
    status: 404
  }
}, { status: 404 });
```

* å…±é€šå‹ `ApiResponse<T>`ï¼ˆ`types/api.ts`ï¼‰ã‚’å¿…ãšä½¿ç”¨ã™ã‚‹ã€‚

```ts
// types/api.ts
export type ApiSuccess<T> = {
  success: true;
  data: T;
};

export type ApiError = {
  success: false;
  error: {
    code: string;
    message: string;
    status?: number;
  };
};

export type ApiResponse<T> = ApiSuccess<T> | ApiError;
```

## ğŸ”§ å®Ÿè£…ä¾‹ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### å®Œå…¨ãªAPIå®Ÿè£…ä¾‹
```ts
// app/api/users/[id]/route.ts
import { NextRequest, NextResponse } from "next/server";
import { parseQueryParams, parseRequestBody } from "@/lib/apiRequest";
import { getRecord, updateRecord } from "@/lib/db/db_CRUD";
import { ApiResponse, User } from "@/types/api";

export async function GET(
  req: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const id = parseInt(params.id);
    if (isNaN(id)) {
      return NextResponse.json<ApiResponse<null>>({
        success: false,
        error: {
          code: "INVALID_ID",
          message: "ç„¡åŠ¹ãªIDã§ã™",
          status: 400
        }
      }, { status: 400 });
    }

    const result = await getRecord<User>("users", id);
    
    if (!result.success) {
      return NextResponse.json<ApiResponse<null>>({
        success: false,
        error: {
          code: result.error.code,
          message: result.error.message,
          status: 404
        }
      }, { status: 404 });
    }

    return NextResponse.json<ApiResponse<User>>({
      success: true,
      data: result.data
    });

  } catch (error) {
    console.error("GET /api/users/[id] error:", error);
    return NextResponse.json<ApiResponse<null>>({
      success: false,
      error: {
        code: "INTERNAL_ERROR",
        message: "å†…éƒ¨ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ",
        status: 500
      }
    }, { status: 500 });
  }
}

export async function PUT(
  req: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    const id = parseInt(params.id);
    const body = await parseRequestBody(req);
    
    if (!body.name || !body.email) {
      return NextResponse.json<ApiResponse<null>>({
        success: false,
        error: {
          code: "VALIDATION_ERROR",
          message: "å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™",
          status: 400
        }
      }, { status: 400 });
    }

    const result = await updateRecord<User>("users", id, body);
    
    if (!result.success) {
      return NextResponse.json<ApiResponse<null>>({
        success: false,
        error: {
          code: result.error.code,
          message: result.error.message,
          status: 404
        }
      }, { status: 404 });
    }

    return NextResponse.json<ApiResponse<User>>({
      success: true,
      data: result.data
    });

  } catch (error) {
    console.error("PUT /api/users/[id] error:", error);
    return NextResponse.json<ApiResponse<null>>({
      success: false,
      error: {
        code: "INTERNAL_ERROR",
        message: "å†…éƒ¨ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ",
        status: 500
      }
    }, { status: 500 });
  }
}
```

### å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã®å®Ÿè£…ä¾‹
```ts
// lib/apiRequest.ts
export const parseQueryParams = (req: NextRequest) => {
  const url = new URL(req.url);
  const params: Record<string, string> = {};
  
  url.searchParams.forEach((value, key) => {
    params[key] = value;
  });
  
  return params;
};

export const parseRequestBody = async <T>(req: NextRequest): Promise<T> => {
  try {
    return await req.json();
  } catch (error) {
    throw new Error("ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
};

export const validateRequiredFields = (
  data: any,
  requiredFields: string[]
): { isValid: boolean; missingFields: string[] } => {
  const missingFields = requiredFields.filter(field => !data[field]);
  
  return {
    isValid: missingFields.length === 0,
    missingFields
  };
};
```

---

## âœ… ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ï¼ˆDAL:src/lib/db/**ï¼‰ã§ã®ãƒ«ãƒ¼ãƒ«

### ğŸ“ åˆ©ç”¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¿…ãšåˆ©ç”¨ã™ã‚‹:
- `src/lib/db/db_advanced.ts`
- `src/lib/db/db_connection.ts` 
- `src/lib/db/db_CRUD.ts`
- `src/lib/db/db_DeleteTable.ts`
- `src/lib/db/db_GetData.ts`

### ğŸ”„ æˆ»ã‚Šå€¤ã®çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
DB ã‚¢ã‚¯ã‚»ã‚¹é–¢æ•°ï¼ˆä¾‹: `getRecord()`, `updateById()` ãªã©ï¼‰ã¯ã€æˆ»ã‚Šå€¤ã«å¿…ãšä»¥ä¸‹ã®æ§‹é€ ã‚’å«ã‚ã‚‹:

```ts
// æˆåŠŸæ™‚
{
  success: true,
  data: T
}

// å¤±æ•—æ™‚  
{
  success: false,
  error: {
    code: string,
    message: string
  }
}
```

### ğŸš« ä¾‹å¤–å‡¦ç†ã®æ–¹é‡
- DAL å´ã§ `success: false` ã¨ãªã£ãŸå ´åˆã¯**ä¾‹å¤–ã‚’æŠ•ã’ãªã„**
- å‘¼ã³å‡ºã—å…ƒã® API å±¤ã§ `ApiResponse<T>` ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦è¿”å´ã™ã‚‹

### ğŸ”§ ORMä½¿ç”¨æ™‚ã®æ³¨æ„
Prismaãƒ»Knexãƒ»TypeORM ãªã©ã® ORM ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã‚‚ã€ã€ŒçµæœãŒå–å¾—ã§ããŸã‹/ã§ããªã‹ã£ãŸã‹ã€ã®åˆ¤å®šã‚’è¡Œã†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’å¿…ãšæŒŸã‚€ã€‚

#### å®Ÿè£…ä¾‹:
```ts
// src/lib/db/db_CRUD.ts
export async function getRecord<T>(table: string, id: number): Promise<DALResponse<T>> {
  try {
    const result = await db(table).where('id', id).first();
    
    if (!result) {
      return {
        success: false,
        error: {
          code: 'RECORD_NOT_FOUND',
          message: `Record with id ${id} not found in ${table}`
        }
      };
    }
    
    return {
      success: true,
      data: result as T
    };
  } catch (error) {
    return {
      success: false,
      error: {
        code: 'DATABASE_ERROR',
        message: error instanceof Error ? error.message : 'Unknown database error'
      }
    };
  }
}
```

---

## âœ… API ä½¿ç”¨æ™‚ã®ãƒ«ãƒ¼ãƒ«ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰:src/hooks/useApi*.tsï¼‰

* `useApiGet<T>(url: string, params?: Record<string, any>)` /
  `useApiPost<T>(url: string, body: any)` ã¨ã„ã£ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’å¿…ãšåˆ©ç”¨ã—ã€ç›´æ¥ `axios.xxx()` ã‚’å‘¼ã°ãªã„ã€‚
* ãƒ•ãƒƒã‚¯ã¯ä»¥ä¸‹ã‚’å¿…ãšè¡Œã†:
  1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ç®¡ç†
  2. æ­£å¸¸ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡æ™‚ã®ãƒ‡ãƒ¼ã‚¿è¿”å´
  3. ç•°å¸¸ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡æ™‚ã®ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ç®¡ç†
* å…±é€šã® Axios ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¨­å®šï¼ˆ`src/lib/apiRequest.ts`ï¼‰å´ã§ã€
  * `baseURL`
  * `timeout`
  * `interceptors`ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
  
  ã‚’ä¸€å…ƒç®¡ç†ã—ã€ãƒ•ãƒƒã‚¯å†…ã§ã¯å€‹åˆ¥è¨­å®šã—ãªã„ã€‚

### ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯å®Ÿè£…ä¾‹
```ts
// hooks/useApiGet.ts
import { useState, useEffect } from 'react';
import { apiClient } from '@/lib/apiRequest';
import { ApiResponse } from '@/types/api';

export const useApiGet = <T>(
  url: string,
  params?: Record<string, any>
) => {
  const [data, setData] = useState<T | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        setError(null);
        
        const response = await apiClient.get<ApiResponse<T>>(url, { params });
        
        if (response.data.success) {
          setData(response.data.data);
        } else {
          setError(response.data.error.message);
        }
      } catch (err) {
        setError(err instanceof Error ? err.message : 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [url, JSON.stringify(params)]);

  return { data, loading, error, refetch: () => fetchData() };
};

// hooks/useApiPost.ts
export const useApiPost = <T>() => {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const postData = async (url: string, body: any): Promise<T | null> => {
    try {
      setLoading(true);
      setError(null);
      
      const response = await apiClient.post<ApiResponse<T>>(url, body);
      
      if (response.data.success) {
        return response.data.data;
      } else {
        setError(response.data.error.message);
        return null;
      }
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
      setError(errorMessage);
      return null;
    } finally {
      setLoading(false);
    }
  };

  return { postData, loading, error };
};
```

### Axiosè¨­å®šä¾‹
```ts
// lib/apiRequest.ts
import axios from 'axios';

export const apiClient = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_BASE_URL || '/api',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼
apiClient.interceptors.request.use(
  (config) => {
    // èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®è¿½åŠ ãªã©
    const token = localStorage.getItem('authToken');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼
apiClient.interceptors.response.use(
  (response) => {
    return response;
  },
  (error) => {
    if (error.response?.status === 401) {
      // èªè¨¼ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
      localStorage.removeItem('authToken');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);
```

---

## âœ… ESLint & TypeScript è¨­å®šä¾‹

```jsonc
// .eslintrc.json
{
  "extends": [
    "next/core-web-vitals",
    "plugin:@typescript-eslint/recommended"
  ],
  "rules": {
    "@typescript-eslint/no-explicit-any": "error",
    "no-console": ["warn", { "allow": ["error"] }],
    "import/order": ["error", { "groups": ["builtin", "external", "local"] }]
  }
}
```

```jsonc
// tsconfig.json (æŠœç²‹)
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx"]
}
```

---

## âœ… é‹ç”¨ä¸Šã®æ³¨æ„

* æ–°ã—ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ã¨ãã¯ã€ã“ã® Cursor ãƒ«ãƒ¼ãƒ«ã‚’ `false` â†’ `true` ã«ã—ã¦ä¸€å·¡ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½ã™ã‚‹ã€‚
* æ—¢å­˜ã®ãƒ«ãƒ¼ãƒ«ã‚’å¤‰æ›´ã—ãŸå ´åˆã¯ `alwaysApply: true` ã«åˆ‡ã‚Šæ›¿ãˆã€CI ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§å¿…ãš ESLint/TS å‹ãƒã‚§ãƒƒã‚¯ã‚’é€šéã•ã›ã‚‹ã€‚

## ğŸš¨ é¿ã‘ã‚‹ã¹ããƒ‘ã‚¿ãƒ¼ãƒ³

- âŒ **ç›´æ¥axiosã‚’å‘¼ã³å‡ºã™**
- âŒ **ä¾‹å¤–ã‚’æŠ•ã’ã‚‹DALé–¢æ•°**
- âŒ **çµ±ä¸€ã•ã‚Œã¦ã„ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼**
- âŒ **é©åˆ‡ã§ãªã„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
- âŒ **ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸURL**
- âŒ **å‹å®‰å…¨æ€§ã‚’ç„¡è¦–ã—ãŸå®Ÿè£…**
- âŒ **ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®ç®¡ç†ã‚’æ€ ã‚‹**
- âŒ **ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®ç®¡ç†ã‚’æ€ ã‚‹**

## ğŸ“‹ å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] çµ±ä¸€ã•ã‚ŒãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹
- [ ] é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹
- [ ] å‹å®‰å…¨æ€§ãŒç¢ºä¿ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ãŒç®¡ç†ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ãŒç®¡ç†ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹
- [ ] é©åˆ‡ãªHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã—ã¦ã„ã‚‹ã‹
- [ ] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ãƒ­ã‚°å‡ºåŠ›ãŒé©åˆ‡ã«è¡Œã‚ã‚Œã¦ã„ã‚‹ã‹